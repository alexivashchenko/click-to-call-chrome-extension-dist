var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,n,o,i,r,a,c,s="",d=0;for(e=Base64._utf8_encode(e);d<e.length;)i=(t=e.charCodeAt(d++))>>2,r=(3&t)<<4|(n=e.charCodeAt(d++))>>4,a=(15&n)<<2|(o=e.charCodeAt(d++))>>6,c=63&o,isNaN(n)?a=c=64:isNaN(o)&&(c=64),s=s+this._keyStr.charAt(i)+this._keyStr.charAt(r)+this._keyStr.charAt(a)+this._keyStr.charAt(c);return s},decode:function(e){var t,n,o,i,r,a,c="",s=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");s<e.length;)t=this._keyStr.indexOf(e.charAt(s++))<<2|(i=this._keyStr.indexOf(e.charAt(s++)))>>4,n=(15&i)<<4|(r=this._keyStr.indexOf(e.charAt(s++)))>>2,o=(3&r)<<6|(a=this._keyStr.indexOf(e.charAt(s++))),c+=String.fromCharCode(t),64!=r&&(c+=String.fromCharCode(n)),64!=a&&(c+=String.fromCharCode(o));return c=Base64._utf8_decode(c)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var o=e.charCodeAt(n);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t},_utf8_decode:function(e){for(var t="",n=0,o=c1=c2=0;n<e.length;)(o=e.charCodeAt(n))<128?(t+=String.fromCharCode(o),n++):o>191&&o<224?(c2=e.charCodeAt(n+1),t+=String.fromCharCode((31&o)<<6|63&c2),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=String.fromCharCode((15&o)<<12|(63&c2)<<6|63&c3),n+=3);return t}},hexcase=0,b64pad="",chrsz=8;function hex_md5(e){return binl2hex(core_md5(str2binl(e),e.length*chrsz))}function b64_md5(e){return binl2b64(core_md5(str2binl(e),e.length*chrsz))}function str_md5(e){return binl2str(core_md5(str2binl(e),e.length*chrsz))}function hex_hmac_md5(e,t){return binl2hex(core_hmac_md5(e,t))}function b64_hmac_md5(e,t){return binl2b64(core_hmac_md5(e,t))}function str_hmac_md5(e,t){return binl2str(core_hmac_md5(e,t))}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc")}function core_md5(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,o=-271733879,i=-1732584194,r=271733878,a=0;a<e.length;a+=16){var c=n,s=o,d=i,l=r;n=md5_ff(n,o,i,r,e[a+0],7,-680876936),r=md5_ff(r,n,o,i,e[a+1],12,-389564586),i=md5_ff(i,r,n,o,e[a+2],17,606105819),o=md5_ff(o,i,r,n,e[a+3],22,-1044525330),n=md5_ff(n,o,i,r,e[a+4],7,-176418897),r=md5_ff(r,n,o,i,e[a+5],12,1200080426),i=md5_ff(i,r,n,o,e[a+6],17,-1473231341),o=md5_ff(o,i,r,n,e[a+7],22,-45705983),n=md5_ff(n,o,i,r,e[a+8],7,1770035416),r=md5_ff(r,n,o,i,e[a+9],12,-1958414417),i=md5_ff(i,r,n,o,e[a+10],17,-42063),o=md5_ff(o,i,r,n,e[a+11],22,-1990404162),n=md5_ff(n,o,i,r,e[a+12],7,1804603682),r=md5_ff(r,n,o,i,e[a+13],12,-40341101),i=md5_ff(i,r,n,o,e[a+14],17,-1502002290),n=md5_gg(n,o=md5_ff(o,i,r,n,e[a+15],22,1236535329),i,r,e[a+1],5,-165796510),r=md5_gg(r,n,o,i,e[a+6],9,-1069501632),i=md5_gg(i,r,n,o,e[a+11],14,643717713),o=md5_gg(o,i,r,n,e[a+0],20,-373897302),n=md5_gg(n,o,i,r,e[a+5],5,-701558691),r=md5_gg(r,n,o,i,e[a+10],9,38016083),i=md5_gg(i,r,n,o,e[a+15],14,-660478335),o=md5_gg(o,i,r,n,e[a+4],20,-405537848),n=md5_gg(n,o,i,r,e[a+9],5,568446438),r=md5_gg(r,n,o,i,e[a+14],9,-1019803690),i=md5_gg(i,r,n,o,e[a+3],14,-187363961),o=md5_gg(o,i,r,n,e[a+8],20,1163531501),n=md5_gg(n,o,i,r,e[a+13],5,-1444681467),r=md5_gg(r,n,o,i,e[a+2],9,-51403784),i=md5_gg(i,r,n,o,e[a+7],14,1735328473),n=md5_hh(n,o=md5_gg(o,i,r,n,e[a+12],20,-1926607734),i,r,e[a+5],4,-378558),r=md5_hh(r,n,o,i,e[a+8],11,-2022574463),i=md5_hh(i,r,n,o,e[a+11],16,1839030562),o=md5_hh(o,i,r,n,e[a+14],23,-35309556),n=md5_hh(n,o,i,r,e[a+1],4,-1530992060),r=md5_hh(r,n,o,i,e[a+4],11,1272893353),i=md5_hh(i,r,n,o,e[a+7],16,-155497632),o=md5_hh(o,i,r,n,e[a+10],23,-1094730640),n=md5_hh(n,o,i,r,e[a+13],4,681279174),r=md5_hh(r,n,o,i,e[a+0],11,-358537222),i=md5_hh(i,r,n,o,e[a+3],16,-722521979),o=md5_hh(o,i,r,n,e[a+6],23,76029189),n=md5_hh(n,o,i,r,e[a+9],4,-640364487),r=md5_hh(r,n,o,i,e[a+12],11,-421815835),i=md5_hh(i,r,n,o,e[a+15],16,530742520),n=md5_ii(n,o=md5_hh(o,i,r,n,e[a+2],23,-995338651),i,r,e[a+0],6,-198630844),r=md5_ii(r,n,o,i,e[a+7],10,1126891415),i=md5_ii(i,r,n,o,e[a+14],15,-1416354905),o=md5_ii(o,i,r,n,e[a+5],21,-57434055),n=md5_ii(n,o,i,r,e[a+12],6,1700485571),r=md5_ii(r,n,o,i,e[a+3],10,-1894986606),i=md5_ii(i,r,n,o,e[a+10],15,-1051523),o=md5_ii(o,i,r,n,e[a+1],21,-2054922799),n=md5_ii(n,o,i,r,e[a+8],6,1873313359),r=md5_ii(r,n,o,i,e[a+15],10,-30611744),i=md5_ii(i,r,n,o,e[a+6],15,-1560198380),o=md5_ii(o,i,r,n,e[a+13],21,1309151649),n=md5_ii(n,o,i,r,e[a+4],6,-145523070),r=md5_ii(r,n,o,i,e[a+11],10,-1120210379),i=md5_ii(i,r,n,o,e[a+2],15,718787259),o=md5_ii(o,i,r,n,e[a+9],21,-343485551),n=safe_add(n,c),o=safe_add(o,s),i=safe_add(i,d),r=safe_add(r,l)}return Array(n,o,i,r)}function md5_cmn(e,t,n,o,i,r){return safe_add(bit_rol(safe_add(safe_add(t,e),safe_add(o,r)),i),n)}function md5_ff(e,t,n,o,i,r,a){return md5_cmn(t&n|~t&o,e,t,i,r,a)}function md5_gg(e,t,n,o,i,r,a){return md5_cmn(t&o|n&~o,e,t,i,r,a)}function md5_hh(e,t,n,o,i,r,a){return md5_cmn(t^n^o,e,t,i,r,a)}function md5_ii(e,t,n,o,i,r,a){return md5_cmn(n^(t|~o),e,t,i,r,a)}function core_hmac_md5(e,t){var n=str2binl(e);n.length>16&&(n=core_md5(n,e.length*chrsz));for(var o=Array(16),i=Array(16),r=0;r<16;r++)o[r]=909522486^n[r],i[r]=1549556828^n[r];var a=core_md5(o.concat(str2binl(t)),512+t.length*chrsz);return core_md5(i.concat(a),640)}function safe_add(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function bit_rol(e,t){return e<<t|e>>>32-t}function str2binl(e){for(var t=Array(),n=(1<<chrsz)-1,o=0;o<e.length*chrsz;o+=chrsz)t[o>>5]|=(e.charCodeAt(o/chrsz)&n)<<o%32;return t}function binl2str(e){for(var t="",n=(1<<chrsz)-1,o=0;o<32*e.length;o+=chrsz)t+=String.fromCharCode(e[o>>5]>>>o%32&n);return t}function binl2hex(e){for(var t=hexcase?"0123456789ABCDEF":"0123456789abcdef",n="",o=0;o<4*e.length;o++)n+=t.charAt(e[o>>2]>>o%4*8+4&15)+t.charAt(e[o>>2]>>o%4*8&15);return n}function binl2b64(e){for(var t="",n=0;n<4*e.length;n+=3)for(var o=(e[n>>2]>>n%4*8&255)<<16|(e[n+1>>2]>>(n+1)%4*8&255)<<8|e[n+2>>2]>>(n+2)%4*8&255,i=0;i<4;i++)8*n+6*i>32*e.length?t+=b64pad:t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(o>>6*(3-i)&63);return t}let Helpers={dev:!0,log:function(...arguments){if(0==Helpers.dev)return!1;arguments.length>0&&arguments.forEach(e=>{console.log(e)})},maybeReloadPage:function(){return alert('Please check "VoiceMPower" settings and reload the page.'),!0},runBackgroundCommand:function(e,t){Helpers.log("runBackgroundCommand start: "+e,t);let n="__rw_chrome_ext_reply_"+(new Date).getTime();try{if(void 0===chrome.runtime)return Helpers.maybeReloadPage(),!1;chrome.runtime.sendMessage({type:e,data:t},(function(t){void 0!==chrome.runtime.lastError&&(void 0!==chrome.runtime.lastError.message?Helpers.log("chrome.runtime.lastError.message for: "+e,t,chrome.runtime.lastError.message):Helpers.log("chrome.runtime.lastError.message for: "+e,t,chrome.runtime.lastError)),document.createEvent("Events").initEvent(n,!1,!1),Helpers.log("runBackgroundCommand end: "+e,t)}))}catch(e){console.log("Error",e),Helpers.maybeReloadPage()}}};console.log("background script started");var lastkey="",myposition=1,chanvars=[],pingcount=0,notID=0,subversion=0,alreadynotified=0,popup=localStorage.popup,clicktoopen=!1;let CTC={phoneLinksInfo:!1,showedNotification:!1,startNotification:!1,notificationOperator:!1,notifications:[],notification:{},startCollectNotificationData:!1,requiredSettings:["server","port","extension","password"],settings:{},setIcon:function(e){console.log("setIcon: "+e),chrome.browserAction.setIcon({path:"/assets/img/tel-19-"+e+".png"})}};function getServer(){return new Promise((e,t)=>{chrome.storage.local.get("settings",(function(n){void 0!==n.settings&&((n=n.settings).server?e(n.server):t("Settings Server not found"))}))})}function stripTrailingSlash(e){return"/"===e.substr(-1)?e.substr(0,e.length-1):e}function findFop2Tab(e){return e=stripTrailingSlash(e)+"/fop2",new Promise((t,n)=>{chrome.tabs.query({},(function(o){o.forEach((function(n){n.url.includes(e)&&t(n)})),n("FOP2 tab was not found")}))})}async function dialPhone(e){e=e.replace(/\D/g,"");let t=await getServer(),n=await findFop2Tab(t);chrome.tabs.get(n.id,(function(t){chrome.tabs.executeScript(t.id,{code:'console.log("External dial: ", '+e+");location.href=\"javascript:dial('"+e+"');\""})}))}function askFirstState(){var e=hex_md5(CTC.settings.password+lastkey);WS.send('<msg data="1|initState||'+e+'" />')}function inArray(e,t){return-1!==t.indexOf(e)}function commandCenter(){function e(e,t){if(myposition==e){var n=localStorage.poplink,o=localStorage.popbody;if(void 0===n&&(n=""),void 0===o&&(o=""),""!=n){var i=/#\{[^\}]*\}/g,r=n.match(i);if(null!==r)for(var a=0;a<r.length;a++){var c=r[a].substr(2,r[a].length-3);i="",i="CLIDNUM"==c||"CLIDNAME"==c?Base64.decode(chanvars[e][c]):chanvars[e][c],n=replace(n,r[a],i)}if(0==n.indexOf("javascript:")){var s=(i=(n=n.substr(11)).split("?"))[0],d={};i[1].split("&").forEach((function(e){d[e.split("=")[0]]=e.split("=")[1]})),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{message:"popup",call:s,params:d},(function(e){}))}))}else 1!=clicktoopen&&chrome.tabs.create({url:n,active:!1})}}}this.zbuttons=function(e,t,n){return!0},this.voicemail=function(e,t,n){botonitos[e].MWISTATE=t,(n=chrome.extension.getViews({type:"popup"})).length&&(e=(n=n[0]).document.getElementById("mwi_"+e),1==t?($(e).removeClass("transparent"),$(e).removeClass("invisible")):2==t?($(e).removeClass("invisible"),$(e).addClass("transparent")):($(e).addClass("invisible"),$(e).removeClass("transparent")))},this.pong=function(e,t,n){setTimeout((function(){WS.ping()}),2e4),WS.totalPings--},this.state=function(e,t,n){let o={};if(o[e]={},o[e].STATE=!1,0<=inArray("RINGING",t=t.split("+"))||0<=inArray("UP",t))o[e].STATE="busy",n="free",t="busy";else if(o[e].STATE="free",n="busy",t="free",myposition==e&&(alreadynotified=0,void 0!==chanvars[e]))for(var i in chanvars[e])delete chanvars[e][i];(i=chrome.extension.getViews({type:"popup"})).length&&(null!==(e=(i=i[0]).document.getElementById("boton_"+e))&&($(e).removeClass(n),$(e).addClass(t)))},this.presence=function(e,t,n){},this.key=function(e,t,n){lastkey=t,Helpers.log("lastkey: "+lastkey)},this.setvar=function(e,t,n){myposition==e&&(1<=(t=Base64.decode(t)).indexOf("=")&&(void 0===chanvars[e]&&(chanvars[e]={}),partes=t.split("="),chanvars[e][partes[0]]=partes[1]))},this.incorrect=function(e,t,n){Helpers.log("Auth incorrect")},this.version=function(e,t,n){e=hex_md5(CTC.settings.password+lastkey),subversion=(subversion=t.split("!")[0].split(".")[1]).replace(/\D/g,""),console.log("Version "+subversion),WS.send('<msg data="1|auth|'+CTC.settings.extension+"|"+e+'" />')},this.qualify=function(e,t,n){return!0},this.clidnum=function(e,t,n){myposition==e&&(void 0===chanvars[e]&&(chanvars[e]={}),chanvars[e].CLIDNUM=t)},this.clidname=function(e,t,n){myposition==e&&(void 0===chanvars[e]&&(chanvars[e]={}),chanvars[e].CLIDNAME=t)},this.fromqueue=function(e,t,n){myposition==e&&(void 0===chanvars[e]&&(chanvars[e]={}),chanvars[e].FROMQUEUE=t)},this.notifyringing=function(t,n,o){e(t)},this.notifyconnect=function(t,n,o){0==alreadynotified&&(e(t),myposition==t&&(alreadynotified=1))}}function docommand(e,t,n,o){"status"==t&&(t="xstatus"),"zbuttons"!=t&&Helpers.log(e+","+t+"="+n+" en slot "+o),"function"==typeof execute[t]&&("key"==t&&(Helpers.log("key lastkey"),Helpers.log(n)),execute[t](e,n,o))}function appendData(e){Helpers.log("appendData"),Helpers.log(e);var t=e.btn;1<=t.indexOf("@")&&(t=t.substring(0,t.indexOf("@"))),docommand(t,e.cmd,e.data,e.slot)}let WS={instance:!1,totalPings:0,defineWebSocketUrl:function(){return"ws://"+CTC.settings.server+":"+CTC.settings.port},send:function(e){if(void 0===WS.instance||0==WS.instance)return Helpers.log("Error. WebSocked is undefined.",WS.instance),!1;e.includes("|ping|")||Helpers.log("Sending WebSocket command: "+e),WS.instance.send(e)},ping:function(){Helpers.log("Ping: "+WS.totalPings),WS.totalPings>5&&Helpers.log("Connection problem with websocket server!"),WS.send('<msg data="1|ping||" />'),WS.totalPings++},connectContext:function(){WS.send('<msg data="GENERAL|contexto|1|" />'),setTimeout((function(){WS.ping()}),1e4)},logResponse:function(e){let t=e;if(t.cmd&&("pong"==t.cmd||"idletimer"==t.cmd||"setidle"==t.cmd))return!1;t.cmd&&("queuemember"==t.cmd||"stats"==t.cmd)&&t.data&&(t.data=JSON.parse(Base64.decode(t.data))),t.cmd&&("clidname"==t.cmd||"clidnum"==t.cmd||"plugin"==t.cmd||"style"==t.cmd||"restrictq"==t.cmd||"permitbtn"==t.cmd||"preferences"==t.cmd||"defaultpreferences"==t.cmd||"vmailpath"==t.cmd||"zbuttons"==t.cmd||"permit"==t.cmd)&&t.data&&(t.data=Base64.decode(t.data)),Helpers.log(t)},connect:function(){if(!1!==WS.instance)return!1;if("WebSocket"in window){let e=WS.defineWebSocketUrl();Helpers.log("Start WebSocket connection: "+e);try{WS.instance=new WebSocket(e)}catch(e){Helpers.log("WebSocket error",e)}WS.instance.onopen=function(){WS.connectContext(),CTC.setIcon("green")},WS.instance.onmessage=function(e){let t=JSON.parse(e.data);appendData(t),WS.logResponse(t),Notifications.catch(t)},WS.instance.onclose=function(){setTimeout((function(){WS.connect()}),5e3),Helpers.log("Unable to connect to server: "+e),CTC.setIcon("red"),WS.instance=!1},WS.instance.onerror=function(e){console.error(e)}}else console.error("Your browser does not support WebSocket connection")}},Notifications={clearOldNotifications:function(){Helpers.log("Clear notifications:",CTC.notifications),CTC.notifications.forEach((function(e){chrome.notifications.clear(e,(function(e){Helpers.log("Notification Removed",e)}))})),CTC.notification={}},incomingCall:async function(e){let t=null,n="Incoming phone call:";e.phoneNumber&&(n=n+"\n"+e.phoneNumber),e.phoneName&&(n=n+"\n"+e.phoneName),chrome.notifications.create("",{requireInteraction:!0,type:"basic",iconUrl:"/assets/img/tel-128.png",title:"Incoming Call",message:n,contextMessage:"Click to call",buttons:[{title:"Answer",iconUrl:"/assets/img/tel-128-green.png"},{title:"Disconnect",iconUrl:"/assets/img/tel-128-red.png"}]},(function(e){t=e,CTC.notifications.push(e)})),chrome.notifications.onButtonClicked.addListener((function(e,t){e==e&&(0===t?Notifications.callAnswered():1===t&&Notifications.callDisconnected())}))},callAnswered:async function(){console.log("Answered");let e=await getServer(),t=await findFop2Tab(e);chrome.tabs.get(t.id,(function(e){chrome.tabs.update(e.id,{active:!0,highlighted:!0}),chrome.tabs.executeScript(e.id,{code:"console.log(\"External command: Answered\");location.href=\"javascript:document.querySelector('#phoneiframe').contentWindow.document.querySelector('#call').click();\""})}))},callDisconnected:async function(){Helpers.log("Disconnected");let e=await getServer(),t=await findFop2Tab(e);chrome.tabs.get(t.id,(function(e){chrome.tabs.update(e.id,{active:!0,highlighted:!0}),chrome.tabs.executeScript(e.id,{code:"console.log(\"External command: Answered\");location.href=\"javascript:document.querySelector('#phoneiframe').contentWindow.document.querySelector('#hang').click();\""})}))},getOperatorId:function(e){"string"==typeof e&&(e=JSON.parse(Base64.decode(e)));let t=e[0].loc;return t=t.replace("Local/",""),t=t.replace("@from-queue/n",""),t=parseInt(t),t},getOperatorState:function(e){return"string"==typeof e&&(e=JSON.parse(Base64.decode(e))),e[0].state},catch:function(e){!0===CTC.startCollectNotificationData&&(e.cmd&&"clidnum"==e.cmd&&e.data&&(CTC.notification.phoneNumber=e.data),e.cmd&&"clidname"==e.cmd&&e.data&&(CTC.notification.phoneName=e.data),e.cmd&&"notifyringing"==e.cmd&&e.data&&1==e.data&&(CTC.startCollectNotificationData=!1,Notifications.incomingCall(CTC.notification))),e.cmd&&"queuemember"==e.cmd&&e.data&&(CTC.notificationOperator=Notifications.getOperatorId(e.data),CTC.notificationOperator==CTC.settings.extension&&("ringing"==Notifications.getOperatorState(e.data)?(console.log("start collect data for notification"),CTC.startCollectNotificationData=!0):(CTC.notification={},Notifications.clearOldNotifications())))}};function getSettings(){return new Promise((e,t)=>{chrome.storage.local.get("settings",(function(n){if(void 0===(n=n.settings))return t({type:"error",content:"Settings is undefined"}),!1;let o=[];CTC.requiredSettings.forEach((function(e){e in n||o.push(e)})),0==o.length?e(n):t({type:"error",content:"Settings is undefined",data:o})}))})}let ContextMenu={contextMenuClick:function(e,t){Helpers.log("Context menu click",e,t,e.selectionText),Helpers.log("Dial phone from context menu: ",e.selectionText,e.selectionText.replace(/\D/g,"")),dialPhone(e.selectionText)},init:function(){chrome.contextMenus.removeAll((function(){chrome.contextMenus.create({id:"MY_CONTEXT_MENU",title:"Dial: '%s'",contexts:["selection"]})})),chrome.contextMenus.onClicked.addListener(ContextMenu.contextMenuClick)}};function addBackendListener(){chrome.runtime.onMessage.addListener((async function(e,t,n){Helpers.log("content message:",e);try{CTC.settings=await getSettings(),CTC.setIcon("green")}catch(e){CTC.setIcon("red"),n("Error: Settings is empty")}return e&&"dialPhone"==e.type&&(dialPhone(e.data),n("Success: dialPhone executed")),e&&"init"==e.type&&(init(),n("Success: init executed")),!0}))}function reloadStorage(){chrome.storage.local.clear(),chrome.storage.local.set({settings:{}},(function(){console.log("Settings reloaded")}))}let extIsLoaded=!1;function extensionInstalled(){chrome.runtime.onInstalled.addListener((function(){reloadStorage(),extIsLoaded=!0,console.log("ext is loaded on installation",extIsLoaded),addBackendListener()})),0==extIsLoaded&&chrome.runtime.onStartup.addListener((function(){extIsLoaded=!0,console.log("ext is loaded on startup",extIsLoaded),addBackendListener()}))}async function init(){if(await extensionInstalled(),console.log("ext is loaded on init",extIsLoaded),0==extIsLoaded)return setTimeout((function(){init()}),1e3),!1;try{CTC.settings=await getSettings(),CTC.setIcon("green")}catch(e){return Helpers.log("Settings is undefined",e),CTC.setIcon("red"),setTimeout((function(){init()}),5e3),!1}ContextMenu.init(),WS.instance=!1,WS.connect()}var execute=new commandCenter;init();