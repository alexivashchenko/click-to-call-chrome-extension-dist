"use strict";console.log("background script started");let CTC={notifications:[]};const CONTEXT_MENU_ID="MY_CONTEXT_MENU";function contextMenuClick(e,t){console.log("context menu click",e,t,e.selectionText),console.log("Dial phone from context menu: ",e.selectionText,e.selectionText.replace(/\D/g,"")),dialPhone(e.selectionText)}function getServer(){return new Promise((e,t)=>{chrome.storage.local.get("settings",(function(n){void 0!==n.settings&&((n=n.settings).server?e(n.server):t("Settings Server not found"))}))})}function stripTrailingSlash(e){return"/"===e.substr(-1)?e.substr(0,e.length-1):e}function findFop2Tab(e){return e=stripTrailingSlash(e)+"/fop2",new Promise((t,n)=>{chrome.tabs.query({},(function(o){o.forEach((function(n){n.url.includes(e)&&t(n)})),n("FOP2 tab was not found")}))})}async function dialPhone(e){e=e.replace(/\D/g,"");let t=await getServer(),n=await findFop2Tab(t);chrome.tabs.get(n.id,(function(t){chrome.tabs.executeScript(t.id,{code:'console.log("External dial: ", '+e+");location.href=\"javascript:dial('"+e+"');\""})}))}function clearOldNotifications(){console.log("Clear Notifications:",CTC.notifications),CTC.notifications.forEach((function(e){chrome.notifications.clear(e,(function(e){console.log("Notification Removed",e)}))}))}async function incomingCall(e){clearOldNotifications();let t=null,n="Incoming phone call:";e.phoneNumber&&(n=n+"\n"+e.phoneNumber),e.phoneName&&(n=n+"\n"+e.phoneName),chrome.notifications.create("",{requireInteraction:!0,type:"basic",iconUrl:"/assets/img/tel-128.png",title:"Incoming Call",message:n,contextMessage:"Click to call",buttons:[{title:"Answer",iconUrl:"/assets/img/tel-128-green.png"},{title:"Disconnect",iconUrl:"/assets/img/tel-128-red.png"}]},(function(e){t=e,CTC.notifications.push(e)})),chrome.notifications.onButtonClicked.addListener((function(e,t){e==e&&(0===t?callAnswered():1===t&&callDisconnected())}))}async function callAnswered(){console.log("Answered");let e=await getServer(),t=await findFop2Tab(e);chrome.tabs.get(t.id,(function(e){chrome.tabs.update(e.id,{active:!0,highlighted:!0}),chrome.tabs.executeScript(e.id,{code:"console.log(\"External command: Answered\");location.href=\"javascript:document.querySelector('#phoneiframe').contentWindow.document.querySelector('#call').click();\""})}))}async function callDisconnected(){console.log("Disconnected");let e=await getServer(),t=await findFop2Tab(e);chrome.tabs.get(t.id,(function(e){chrome.tabs.update(e.id,{active:!0,highlighted:!0}),chrome.tabs.executeScript(e.id,{code:"console.log(\"External command: Answered\");location.href=\"javascript:document.querySelector('#phoneiframe').contentWindow.document.querySelector('#hang').click();\""})}))}chrome.contextMenus.removeAll((function(){chrome.contextMenus.create({id:CONTEXT_MENU_ID,title:"Dial: '%s'",contexts:["selection"]})})),chrome.contextMenus.onClicked.addListener(contextMenuClick),chrome.runtime.onInstalled.addListener((function(){chrome.storage.local.clear(),chrome.storage.local.set({settings:{}},(function(){}))})),chrome.runtime.onMessage.addListener((async function(e,t,n){return console.log("content message:",e),e&&"dialPhone"==e.type&&(dialPhone(e.data),n("success")),e&&"incomingCall"==e.type&&(incomingCall(e.data),n("success")),e&&"clearOldNotifications"==e.type&&(clearOldNotifications(),n("success")),!0}));