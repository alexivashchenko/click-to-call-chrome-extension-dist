var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(n){var e,t,r,o,i,c,a,d="",s=0;for(n=Base64._utf8_encode(n);s<n.length;)o=(e=n.charCodeAt(s++))>>2,i=(3&e)<<4|(t=n.charCodeAt(s++))>>4,c=(15&t)<<2|(r=n.charCodeAt(s++))>>6,a=63&r,isNaN(t)?c=a=64:isNaN(r)&&(a=64),d=d+this._keyStr.charAt(o)+this._keyStr.charAt(i)+this._keyStr.charAt(c)+this._keyStr.charAt(a);return d},decode:function(n){var e,t,r,o,i,c,a="",d=0;for(n=n.replace(/[^A-Za-z0-9\+\/\=]/g,"");d<n.length;)e=this._keyStr.indexOf(n.charAt(d++))<<2|(o=this._keyStr.indexOf(n.charAt(d++)))>>4,t=(15&o)<<4|(i=this._keyStr.indexOf(n.charAt(d++)))>>2,r=(3&i)<<6|(c=this._keyStr.indexOf(n.charAt(d++))),a+=String.fromCharCode(e),64!=i&&(a+=String.fromCharCode(t)),64!=c&&(a+=String.fromCharCode(r));return a=Base64._utf8_decode(a)},_utf8_encode:function(n){n=n.replace(/\r\n/g,"\n");for(var e="",t=0;t<n.length;t++){var r=n.charCodeAt(t);r<128?e+=String.fromCharCode(r):r>127&&r<2048?(e+=String.fromCharCode(r>>6|192),e+=String.fromCharCode(63&r|128)):(e+=String.fromCharCode(r>>12|224),e+=String.fromCharCode(r>>6&63|128),e+=String.fromCharCode(63&r|128))}return e},_utf8_decode:function(n){for(var e="",t=0,r=c1=c2=0;t<n.length;)(r=n.charCodeAt(t))<128?(e+=String.fromCharCode(r),t++):r>191&&r<224?(c2=n.charCodeAt(t+1),e+=String.fromCharCode((31&r)<<6|63&c2),t+=2):(c2=n.charCodeAt(t+1),c3=n.charCodeAt(t+2),e+=String.fromCharCode((15&r)<<12|(63&c2)<<6|63&c3),t+=3);return e}},hexcase=0,b64pad="",chrsz=8;function hex_md5(n){return binl2hex(core_md5(str2binl(n),n.length*chrsz))}function b64_md5(n){return binl2b64(core_md5(str2binl(n),n.length*chrsz))}function str_md5(n){return binl2str(core_md5(str2binl(n),n.length*chrsz))}function hex_hmac_md5(n,e){return binl2hex(core_hmac_md5(n,e))}function b64_hmac_md5(n,e){return binl2b64(core_hmac_md5(n,e))}function str_hmac_md5(n,e){return binl2str(core_hmac_md5(n,e))}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc")}function core_md5(n,e){n[e>>5]|=128<<e%32,n[14+(e+64>>>9<<4)]=e;for(var t=1732584193,r=-271733879,o=-1732584194,i=271733878,c=0;c<n.length;c+=16){var a=t,d=r,s=o,f=i;t=md5_ff(t,r,o,i,n[c+0],7,-680876936),i=md5_ff(i,t,r,o,n[c+1],12,-389564586),o=md5_ff(o,i,t,r,n[c+2],17,606105819),r=md5_ff(r,o,i,t,n[c+3],22,-1044525330),t=md5_ff(t,r,o,i,n[c+4],7,-176418897),i=md5_ff(i,t,r,o,n[c+5],12,1200080426),o=md5_ff(o,i,t,r,n[c+6],17,-1473231341),r=md5_ff(r,o,i,t,n[c+7],22,-45705983),t=md5_ff(t,r,o,i,n[c+8],7,1770035416),i=md5_ff(i,t,r,o,n[c+9],12,-1958414417),o=md5_ff(o,i,t,r,n[c+10],17,-42063),r=md5_ff(r,o,i,t,n[c+11],22,-1990404162),t=md5_ff(t,r,o,i,n[c+12],7,1804603682),i=md5_ff(i,t,r,o,n[c+13],12,-40341101),o=md5_ff(o,i,t,r,n[c+14],17,-1502002290),t=md5_gg(t,r=md5_ff(r,o,i,t,n[c+15],22,1236535329),o,i,n[c+1],5,-165796510),i=md5_gg(i,t,r,o,n[c+6],9,-1069501632),o=md5_gg(o,i,t,r,n[c+11],14,643717713),r=md5_gg(r,o,i,t,n[c+0],20,-373897302),t=md5_gg(t,r,o,i,n[c+5],5,-701558691),i=md5_gg(i,t,r,o,n[c+10],9,38016083),o=md5_gg(o,i,t,r,n[c+15],14,-660478335),r=md5_gg(r,o,i,t,n[c+4],20,-405537848),t=md5_gg(t,r,o,i,n[c+9],5,568446438),i=md5_gg(i,t,r,o,n[c+14],9,-1019803690),o=md5_gg(o,i,t,r,n[c+3],14,-187363961),r=md5_gg(r,o,i,t,n[c+8],20,1163531501),t=md5_gg(t,r,o,i,n[c+13],5,-1444681467),i=md5_gg(i,t,r,o,n[c+2],9,-51403784),o=md5_gg(o,i,t,r,n[c+7],14,1735328473),t=md5_hh(t,r=md5_gg(r,o,i,t,n[c+12],20,-1926607734),o,i,n[c+5],4,-378558),i=md5_hh(i,t,r,o,n[c+8],11,-2022574463),o=md5_hh(o,i,t,r,n[c+11],16,1839030562),r=md5_hh(r,o,i,t,n[c+14],23,-35309556),t=md5_hh(t,r,o,i,n[c+1],4,-1530992060),i=md5_hh(i,t,r,o,n[c+4],11,1272893353),o=md5_hh(o,i,t,r,n[c+7],16,-155497632),r=md5_hh(r,o,i,t,n[c+10],23,-1094730640),t=md5_hh(t,r,o,i,n[c+13],4,681279174),i=md5_hh(i,t,r,o,n[c+0],11,-358537222),o=md5_hh(o,i,t,r,n[c+3],16,-722521979),r=md5_hh(r,o,i,t,n[c+6],23,76029189),t=md5_hh(t,r,o,i,n[c+9],4,-640364487),i=md5_hh(i,t,r,o,n[c+12],11,-421815835),o=md5_hh(o,i,t,r,n[c+15],16,530742520),t=md5_ii(t,r=md5_hh(r,o,i,t,n[c+2],23,-995338651),o,i,n[c+0],6,-198630844),i=md5_ii(i,t,r,o,n[c+7],10,1126891415),o=md5_ii(o,i,t,r,n[c+14],15,-1416354905),r=md5_ii(r,o,i,t,n[c+5],21,-57434055),t=md5_ii(t,r,o,i,n[c+12],6,1700485571),i=md5_ii(i,t,r,o,n[c+3],10,-1894986606),o=md5_ii(o,i,t,r,n[c+10],15,-1051523),r=md5_ii(r,o,i,t,n[c+1],21,-2054922799),t=md5_ii(t,r,o,i,n[c+8],6,1873313359),i=md5_ii(i,t,r,o,n[c+15],10,-30611744),o=md5_ii(o,i,t,r,n[c+6],15,-1560198380),r=md5_ii(r,o,i,t,n[c+13],21,1309151649),t=md5_ii(t,r,o,i,n[c+4],6,-145523070),i=md5_ii(i,t,r,o,n[c+11],10,-1120210379),o=md5_ii(o,i,t,r,n[c+2],15,718787259),r=md5_ii(r,o,i,t,n[c+9],21,-343485551),t=safe_add(t,a),r=safe_add(r,d),o=safe_add(o,s),i=safe_add(i,f)}return Array(t,r,o,i)}function md5_cmn(n,e,t,r,o,i){return safe_add(bit_rol(safe_add(safe_add(e,n),safe_add(r,i)),o),t)}function md5_ff(n,e,t,r,o,i,c){return md5_cmn(e&t|~e&r,n,e,o,i,c)}function md5_gg(n,e,t,r,o,i,c){return md5_cmn(e&r|t&~r,n,e,o,i,c)}function md5_hh(n,e,t,r,o,i,c){return md5_cmn(e^t^r,n,e,o,i,c)}function md5_ii(n,e,t,r,o,i,c){return md5_cmn(t^(e|~r),n,e,o,i,c)}function core_hmac_md5(n,e){var t=str2binl(n);t.length>16&&(t=core_md5(t,n.length*chrsz));for(var r=Array(16),o=Array(16),i=0;i<16;i++)r[i]=909522486^t[i],o[i]=1549556828^t[i];var c=core_md5(r.concat(str2binl(e)),512+e.length*chrsz);return core_md5(o.concat(c),640)}function safe_add(n,e){var t=(65535&n)+(65535&e);return(n>>16)+(e>>16)+(t>>16)<<16|65535&t}function bit_rol(n,e){return n<<e|n>>>32-e}function str2binl(n){for(var e=Array(),t=(1<<chrsz)-1,r=0;r<n.length*chrsz;r+=chrsz)e[r>>5]|=(n.charCodeAt(r/chrsz)&t)<<r%32;return e}function binl2str(n){for(var e="",t=(1<<chrsz)-1,r=0;r<32*n.length;r+=chrsz)e+=String.fromCharCode(n[r>>5]>>>r%32&t);return e}function binl2hex(n){for(var e=hexcase?"0123456789ABCDEF":"0123456789abcdef",t="",r=0;r<4*n.length;r++)t+=e.charAt(n[r>>2]>>r%4*8+4&15)+e.charAt(n[r>>2]>>r%4*8&15);return t}function binl2b64(n){for(var e="",t=0;t<4*n.length;t+=3)for(var r=(n[t>>2]>>t%4*8&255)<<16|(n[t+1>>2]>>(t+1)%4*8&255)<<8|n[t+2>>2]>>(t+2)%4*8&255,o=0;o<4;o++)8*t+6*o>32*n.length?e+=b64pad:e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>6*(3-o)&63);return e}function inIframe(){try{return window.self!==window.top}catch(n){return!0}}if(inIframe())console.log("Extension loaded inside iframe. Abort.");else{let n={dev:!0,phoneLinksInfo:!1,showedNotification:!1,notification:{},requiredSettings:["ssl","server","port","extension","password"],settings:{},log:function(...arguments){if(0==n.dev)return!1;arguments.length>0&&arguments.forEach(n=>{console.log(n)})}},e=!0,t=!0,r=!1,o="",i=1,c=null,a=null,d="",s=null,f=null,h=0,u=0,l=[];function inArray(n,e){return-1!==e.indexOf(n)}function __debug(...arguments){if(0==e)return!1;arguments.length>0&&arguments.forEach(n=>{"string"!=typeof n||n.includes("style=")||n.includes("ping=")||n.includes("pong=")||n.includes("plugin=")||void 0!==window.console&&console.log(n)})}function send(n){if(void 0===r||0==r)return __debug("Error. WebSocked is undefined.",r),!1;n.includes("|ping|")||__debug("sending command "+n),r.send(n)}function sendsPing(){__debug("ping "+h),5<h&&__debug("Connection problem with websocket server!"),send('<msg data="1|ping||" />'),h++}function connectContext(){send(""!==o?'<msg data="'+o.toUpperCase()+'|contexto|1|" />':'<msg data="GENERAL|contexto|1|" />'),setTimeout((function(){sendsPing()}),1e4)}function doCommand(n,e,t,r){"status"==e&&(e="xstatus"),"zbuttons"!=e&&__debug(n+","+e+"="+t+" en slot "+r),"function"==typeof execute[e]&&execute[e](n,t,r)}function appendData(n){var e=n.btn;1<=e.indexOf("@")&&(e=e.substring(0,e.indexOf("@"))),doCommand(e,n.cmd,n.data,n.slot)}function responseReact(e){if(e.cmd&&"pong"==e.cmd)return!1;n.log("responseReact",e)}function notification(e){return!!window.location.href.includes(n.settings.server)&&((!e.cmd||"pong"!=e.cmd)&&(e.cmd&&"state"==e.cmd&&e.data&&("DOWN"==e.data||"UP"==e.data)?(n.showedNotification=!1,runBackgroundCommand("clearOldNotifications",null),!1):(e.cmd&&"clidnum"==e.cmd&&e.data&&(n.notification.phoneNumber=Base64.decode(e.data)),e.cmd&&"clidname"==e.cmd&&e.data&&(n.notification.phoneName=Base64.decode(e.data)),void(e.cmd&&"notifyringing"==e.cmd&&e.data&&1==e.data&&!1===n.showedNotification&&(n.log("Show Notification",n.notification),runBackgroundCommand("incomingCall",n.notification),n.showedNotification=!0,n.notification={})))))}function defineWebSocketUrl(){let e="ws";return"true"==n.settings.ssl&&(e="wss"),e+"://"+n.settings.server+":"+n.settings.port}function connectWebsocket(){if(!1!==r)return!1;if("WebSocket"in window){let e=defineWebSocketUrl();n.log("Start WebSocket connection: "+e);try{r=new WebSocket(e)}catch(e){n.log("WebSocket error",e)}r.onopen=function(){connectContext()},r.onmessage=function(n){let e=JSON.parse(n.data);appendData(e),responseReact(e),notification(e)},r.onclose=function(){setTimeout((function(){connectWebsocket()}),5e3),n.log("Unable to connect to server: "+e)},r.onerror=function(n){__debug(n),console.error(n)}}else console.error("Your browser does not support WebSocket connection")}function stripNonNumeric(n){n+="";for(var e=/^\d$/,t="",r=0;r<n.length;r++)e.test(n.charAt(r))&&("."==n.charAt(r)&&-1!=t.indexOf(".")||"-"==n.charAt(r)&&0!=t.length||(t+=n.charAt(r)));return t}function commandCenter(){function n(n,e){if(i==n){var t=localStorage.poplink,r=localStorage.popbody;if(void 0===t&&(t=""),void 0===r&&(r=""),""!=t){var o=/#\{[^\}]*\}/g,c=t.match(o);if(null!==c)for(var a=0;a<c.length;a++){var d=c[a].substr(2,c[a].length-3);o="",o="CLIDNUM"==d||"CLIDNAME"==d?Base64.decode(chanvars[n][d]):chanvars[n][d],t=replace(t,c[a],o)}}if("undefined"!=typeof popup&&1==popup&&(translate("&"+e),void 0!==chanvars[n]))for(d in chanvars[n]){if("CLIDNUM"==d||"CLIDNAME"==d)value=Base64.decode(chanvars[n][d]);else if(/^[0-9]*$/.test(chanvars[n][d]))value=chanvars[n][d];else try{value=windows.atob(chanvars[n][d])}catch(e){value=chanvars[n][d]}value}}}this.zbuttons=function(n,e,t){for(l=[],chanvars=[],__debug(e),29<=subversion?e=Base64.decode(e).split("\n"):(n=new Inflator(new Base64Reader(e)),e=new TextReader(new Utf8Translator(n)).readToEnd().split("\n")),t=0;t<e.length;t++){var r=e[t].split("!"),o=r[0].split("@")[0];for(n=0;n<r.length;n++){var c=r[n].split("=",2);null==l[o]&&(l[o]={}),l[o][c[0]]=c[1],""!==c[0]&&"EXTENSION"==c[0]&&c[1]==a&&(i=o,__debug("My position is "+i))}}},this.voicemail=function(n,e,t){return!1},this.pong=function(n,e,t){setTimeout((function(){sendsPing()}),2e4),h--},this.state=function(n,e,t){if(0<=inArray("RINGING",e=e.split("+"))||0<=inArray("UP",e))e="busy";else if(e="free",i==n&&(u=0,void 0!==chanvars[n]))for(var r in chanvars[n])delete chanvars[n][r]},this.presence=function(n,e,t){},this.key=function(n,e,t){d=e,__debug("lastkey: "+d)},this.setvar=function(n,e,t){i==n&&1<=(e=Base64.decode(e)).indexOf("=")&&(void 0===chanvars[n]&&(chanvars[n]={}),partes=e.split("="),chanvars[n][partes[0]]=partes[1])},this.incorrect=function(n,e,t){__debug("Auth incorrect")},this.version=function(n,e,t){n=hex_md5(c+d),subversion=e.split("!")[0].split(".")[1],subversion=subversion.replace(/\D/g,""),send('<msg data="1|auth|'+a+"|"+n+'" />')},this.qualify=function(n,e,t){return!1},this.clidnum=function(n,e,t){i==n&&(void 0===chanvars[n]&&(chanvars[n]={}),chanvars[n].CLIDNUM=e)},this.clidname=function(n,e,t){i==n&&(void 0===chanvars[n]&&(chanvars[n]={}),chanvars[n].CLIDNAME=e)},this.fromqueue=function(n,e,t){i==n&&(void 0===chanvars[n]&&(chanvars[n]={}),chanvars[n].FROMQUEUE=e)},this.notifyringing=function(e,t,r){n(e,"incoming_call")},this.notifyconnect=function(e,t,r){0==u&&(n(e,"connected_call"),i==e&&(u=1))}}var execute=new commandCenter;function phoneClickEventListener(n){n.preventDefault(),runBackgroundCommand("dialPhone",n.currentTarget.href.replace("callto:","").replace("tel:",""))}function addPhoneLinks(n){n.forEach(n=>{n.removeEventListener("click",phoneClickEventListener),n.addEventListener("click",phoneClickEventListener)})}function runBackgroundCommand(e,t){let r="__rw_chrome_ext_reply_"+(new Date).getTime();chrome.runtime.sendMessage({type:e,data:t},(function(t){document.createEvent("Events").initEvent(r,!1,!1),n.log("runBackgroundCommand."+e,t)}))}function getSettings(){return new Promise((e,t)=>{chrome.storage.local.get("settings",(function(r){r=r.settings;let o=[];n.requiredSettings.forEach((function(n){void 0===r[n]&&o.push(n)})),0==o.length?e(r):t({type:"error",content:"Settings is undefined",data:o})}))})}function setUpWebSockedSettings(){t=n.settings.ssl,s=n.settings.server,f=n.settings.port,a=n.settings.extension,c=n.settings.password}function ifFop2Page(){return!(!n.settings.server||!window.location.href.includes(n.settings.server))}function proceedPhoneLinks(){let e=!1;ifFop2Page()&&connectWebsocket(),setInterval(()=>{let t=document.querySelectorAll('a.click-to-call[href*="callto"], a.click-to-call[href*="tel"]');t.length>0?(n.phoneLinksInfo&&n.log("Phone links founded: "+t.length),!1!==e||ifFop2Page()||connectWebsocket(),addPhoneLinks(t),e=!0):!1===e&&n.phoneLinksInfo&&n.log("Phone links not found...")},2e3)}async function init(){n.settings=await getSettings(),n.log("CTC.settings",n.settings),setUpWebSockedSettings(),proceedPhoneLinks()}window.addEventListener("load",()=>{init()},!1)}