var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(n){var e,t,o,i,r,c,s,a="",d=0;for(n=Base64._utf8_encode(n);d<n.length;)i=(e=n.charCodeAt(d++))>>2,r=(3&e)<<4|(t=n.charCodeAt(d++))>>4,c=(15&t)<<2|(o=n.charCodeAt(d++))>>6,s=63&o,isNaN(t)?c=s=64:isNaN(o)&&(s=64),a=a+this._keyStr.charAt(i)+this._keyStr.charAt(r)+this._keyStr.charAt(c)+this._keyStr.charAt(s);return a},decode:function(n){var e,t,o,i,r,c,s="",a=0;for(n=n.replace(/[^A-Za-z0-9\+\/\=]/g,"");a<n.length;)e=this._keyStr.indexOf(n.charAt(a++))<<2|(i=this._keyStr.indexOf(n.charAt(a++)))>>4,t=(15&i)<<4|(r=this._keyStr.indexOf(n.charAt(a++)))>>2,o=(3&r)<<6|(c=this._keyStr.indexOf(n.charAt(a++))),s+=String.fromCharCode(e),64!=r&&(s+=String.fromCharCode(t)),64!=c&&(s+=String.fromCharCode(o));return s=Base64._utf8_decode(s)},_utf8_encode:function(n){n=n.replace(/\r\n/g,"\n");for(var e="",t=0;t<n.length;t++){var o=n.charCodeAt(t);o<128?e+=String.fromCharCode(o):o>127&&o<2048?(e+=String.fromCharCode(o>>6|192),e+=String.fromCharCode(63&o|128)):(e+=String.fromCharCode(o>>12|224),e+=String.fromCharCode(o>>6&63|128),e+=String.fromCharCode(63&o|128))}return e},_utf8_decode:function(n){for(var e="",t=0,o=c1=c2=0;t<n.length;)(o=n.charCodeAt(t))<128?(e+=String.fromCharCode(o),t++):o>191&&o<224?(c2=n.charCodeAt(t+1),e+=String.fromCharCode((31&o)<<6|63&c2),t+=2):(c2=n.charCodeAt(t+1),c3=n.charCodeAt(t+2),e+=String.fromCharCode((15&o)<<12|(63&c2)<<6|63&c3),t+=3);return e}},hexcase=0,b64pad="",chrsz=8;function hex_md5(n){return binl2hex(core_md5(str2binl(n),n.length*chrsz))}function b64_md5(n){return binl2b64(core_md5(str2binl(n),n.length*chrsz))}function str_md5(n){return binl2str(core_md5(str2binl(n),n.length*chrsz))}function hex_hmac_md5(n,e){return binl2hex(core_hmac_md5(n,e))}function b64_hmac_md5(n,e){return binl2b64(core_hmac_md5(n,e))}function str_hmac_md5(n,e){return binl2str(core_hmac_md5(n,e))}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc")}function core_md5(n,e){n[e>>5]|=128<<e%32,n[14+(e+64>>>9<<4)]=e;for(var t=1732584193,o=-271733879,i=-1732584194,r=271733878,c=0;c<n.length;c+=16){var s=t,a=o,d=i,f=r;t=md5_ff(t,o,i,r,n[c+0],7,-680876936),r=md5_ff(r,t,o,i,n[c+1],12,-389564586),i=md5_ff(i,r,t,o,n[c+2],17,606105819),o=md5_ff(o,i,r,t,n[c+3],22,-1044525330),t=md5_ff(t,o,i,r,n[c+4],7,-176418897),r=md5_ff(r,t,o,i,n[c+5],12,1200080426),i=md5_ff(i,r,t,o,n[c+6],17,-1473231341),o=md5_ff(o,i,r,t,n[c+7],22,-45705983),t=md5_ff(t,o,i,r,n[c+8],7,1770035416),r=md5_ff(r,t,o,i,n[c+9],12,-1958414417),i=md5_ff(i,r,t,o,n[c+10],17,-42063),o=md5_ff(o,i,r,t,n[c+11],22,-1990404162),t=md5_ff(t,o,i,r,n[c+12],7,1804603682),r=md5_ff(r,t,o,i,n[c+13],12,-40341101),i=md5_ff(i,r,t,o,n[c+14],17,-1502002290),t=md5_gg(t,o=md5_ff(o,i,r,t,n[c+15],22,1236535329),i,r,n[c+1],5,-165796510),r=md5_gg(r,t,o,i,n[c+6],9,-1069501632),i=md5_gg(i,r,t,o,n[c+11],14,643717713),o=md5_gg(o,i,r,t,n[c+0],20,-373897302),t=md5_gg(t,o,i,r,n[c+5],5,-701558691),r=md5_gg(r,t,o,i,n[c+10],9,38016083),i=md5_gg(i,r,t,o,n[c+15],14,-660478335),o=md5_gg(o,i,r,t,n[c+4],20,-405537848),t=md5_gg(t,o,i,r,n[c+9],5,568446438),r=md5_gg(r,t,o,i,n[c+14],9,-1019803690),i=md5_gg(i,r,t,o,n[c+3],14,-187363961),o=md5_gg(o,i,r,t,n[c+8],20,1163531501),t=md5_gg(t,o,i,r,n[c+13],5,-1444681467),r=md5_gg(r,t,o,i,n[c+2],9,-51403784),i=md5_gg(i,r,t,o,n[c+7],14,1735328473),t=md5_hh(t,o=md5_gg(o,i,r,t,n[c+12],20,-1926607734),i,r,n[c+5],4,-378558),r=md5_hh(r,t,o,i,n[c+8],11,-2022574463),i=md5_hh(i,r,t,o,n[c+11],16,1839030562),o=md5_hh(o,i,r,t,n[c+14],23,-35309556),t=md5_hh(t,o,i,r,n[c+1],4,-1530992060),r=md5_hh(r,t,o,i,n[c+4],11,1272893353),i=md5_hh(i,r,t,o,n[c+7],16,-155497632),o=md5_hh(o,i,r,t,n[c+10],23,-1094730640),t=md5_hh(t,o,i,r,n[c+13],4,681279174),r=md5_hh(r,t,o,i,n[c+0],11,-358537222),i=md5_hh(i,r,t,o,n[c+3],16,-722521979),o=md5_hh(o,i,r,t,n[c+6],23,76029189),t=md5_hh(t,o,i,r,n[c+9],4,-640364487),r=md5_hh(r,t,o,i,n[c+12],11,-421815835),i=md5_hh(i,r,t,o,n[c+15],16,530742520),t=md5_ii(t,o=md5_hh(o,i,r,t,n[c+2],23,-995338651),i,r,n[c+0],6,-198630844),r=md5_ii(r,t,o,i,n[c+7],10,1126891415),i=md5_ii(i,r,t,o,n[c+14],15,-1416354905),o=md5_ii(o,i,r,t,n[c+5],21,-57434055),t=md5_ii(t,o,i,r,n[c+12],6,1700485571),r=md5_ii(r,t,o,i,n[c+3],10,-1894986606),i=md5_ii(i,r,t,o,n[c+10],15,-1051523),o=md5_ii(o,i,r,t,n[c+1],21,-2054922799),t=md5_ii(t,o,i,r,n[c+8],6,1873313359),r=md5_ii(r,t,o,i,n[c+15],10,-30611744),i=md5_ii(i,r,t,o,n[c+6],15,-1560198380),o=md5_ii(o,i,r,t,n[c+13],21,1309151649),t=md5_ii(t,o,i,r,n[c+4],6,-145523070),r=md5_ii(r,t,o,i,n[c+11],10,-1120210379),i=md5_ii(i,r,t,o,n[c+2],15,718787259),o=md5_ii(o,i,r,t,n[c+9],21,-343485551),t=safe_add(t,s),o=safe_add(o,a),i=safe_add(i,d),r=safe_add(r,f)}return Array(t,o,i,r)}function md5_cmn(n,e,t,o,i,r){return safe_add(bit_rol(safe_add(safe_add(e,n),safe_add(o,r)),i),t)}function md5_ff(n,e,t,o,i,r,c){return md5_cmn(e&t|~e&o,n,e,i,r,c)}function md5_gg(n,e,t,o,i,r,c){return md5_cmn(e&o|t&~o,n,e,i,r,c)}function md5_hh(n,e,t,o,i,r,c){return md5_cmn(e^t^o,n,e,i,r,c)}function md5_ii(n,e,t,o,i,r,c){return md5_cmn(t^(e|~o),n,e,i,r,c)}function core_hmac_md5(n,e){var t=str2binl(n);t.length>16&&(t=core_md5(t,n.length*chrsz));for(var o=Array(16),i=Array(16),r=0;r<16;r++)o[r]=909522486^t[r],i[r]=1549556828^t[r];var c=core_md5(o.concat(str2binl(e)),512+e.length*chrsz);return core_md5(i.concat(c),640)}function safe_add(n,e){var t=(65535&n)+(65535&e);return(n>>16)+(e>>16)+(t>>16)<<16|65535&t}function bit_rol(n,e){return n<<e|n>>>32-e}function str2binl(n){for(var e=Array(),t=(1<<chrsz)-1,o=0;o<n.length*chrsz;o+=chrsz)e[o>>5]|=(n.charCodeAt(o/chrsz)&t)<<o%32;return e}function binl2str(n){for(var e="",t=(1<<chrsz)-1,o=0;o<32*n.length;o+=chrsz)e+=String.fromCharCode(n[o>>5]>>>o%32&t);return e}function binl2hex(n){for(var e=hexcase?"0123456789ABCDEF":"0123456789abcdef",t="",o=0;o<4*n.length;o++)t+=e.charAt(n[o>>2]>>o%4*8+4&15)+e.charAt(n[o>>2]>>o%4*8&15);return t}function binl2b64(n){for(var e="",t=0;t<4*n.length;t+=3)for(var o=(n[t>>2]>>t%4*8&255)<<16|(n[t+1>>2]>>(t+1)%4*8&255)<<8|n[t+2>>2]>>(t+2)%4*8&255,i=0;i<4;i++)8*t+6*i>32*n.length?e+=b64pad:e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(o>>6*(3-i)&63);return e}let CTC={dev:!0,phoneLinksInfo:!1,notification:{},requiredSettings:["ssl","server","port","extension","password"],settings:{},log:function(...arguments){if(0==CTC.dev)return!1;arguments.length>0&&arguments.forEach(n=>{console.log(n)})}},_debug=!0,ssl=!0,ws=!1,context="",myposition=1,secret=null,exten=null,lastkey="",wshost=null,wsport=null,pingcount=0,alreadynotified=0,prefix="",botonitos=[],activeCalls=[];function inArray(n,e){return-1!==e.indexOf(n)}function __debug(...arguments){if(0==_debug)return!1;arguments.length>0&&arguments.forEach(n=>{"string"!=typeof n||n.includes("style=")||n.includes("ping=")||n.includes("pong=")||n.includes("plugin=")||void 0!==window.console&&console.log(n)})}function send(n){if(void 0===ws||0==ws)return __debug("Error. WebSocked is undefined.",ws),!1;n.includes("|ping|")||__debug("sending command "+n),ws.send(n)}function sendsPing(){__debug("ping "+pingcount),5<pingcount&&__debug("Connection problem with websocket server!"),send('<msg data="1|ping||" />'),pingcount++}function connectContext(){send(""!==context?'<msg data="'+context.toUpperCase()+'|contexto|1|" />':'<msg data="GENERAL|contexto|1|" />'),setTimeout((function(){sendsPing()}),1e4)}function doCommand(n,e,t,o){"status"==e&&(e="xstatus"),"zbuttons"!=e&&__debug(n+","+e+"="+t+" en slot "+o),"function"==typeof execute[e]&&execute[e](n,t,o)}function appendData(n){var e=n.btn;1<=e.indexOf("@")&&(e=e.substring(0,e.indexOf("@"))),doCommand(e,n.cmd,n.data,n.slot)}function responseReact(n){if(n.cmd&&"pong"==n.cmd)return!1;CTC.log("responseReact",n)}function saveShowedNotification(n){chrome.storage.sync.set({showedNotification:n},(function(){}))}function notification(n){return!!window.location.href.includes(CTC.settings.server)&&((!n.cmd||"pong"!=n.cmd)&&void chrome.storage.sync.get(["showedNotification"],(function(e){let t=e.showedNotification;if(n.cmd&&"state"==n.cmd&&n.data&&("DOWN"==n.data||"UP"==n.data))return saveShowedNotification(!1),!1;n.cmd&&"clidnum"==n.cmd&&n.data&&(CTC.notification.phoneNumber=Base64.decode(n.data)),n.cmd&&"clidname"==n.cmd&&n.data&&(CTC.notification.phoneName=Base64.decode(n.data)),n.cmd&&"notifyringing"==n.cmd&&n.data&&1==n.data&&!1===t&&(CTC.log("Show Notification",CTC.notification),runBackgroundCommand("incomingCall",CTC.notification),saveShowedNotification(!0),CTC.notification={})})))}function defineWebSocketUrl(){let n="ws";return"true"==CTC.settings.ssl&&(n="wss"),n+"://"+CTC.settings.server+":"+CTC.settings.port}function connectWebsocket(){if(!1!==ws)return!1;if("WebSocket"in window){let n=defineWebSocketUrl();CTC.log("Start WebSocket connection: "+n);try{ws=new WebSocket(n)}catch(n){CTC.log("WebSocket error",n)}ws.onopen=function(){connectContext()},ws.onmessage=function(n){let e=JSON.parse(n.data);appendData(e),responseReact(e),notification(e)},ws.onclose=function(){setTimeout((function(){connectWebsocket()}),5e3),CTC.log("Unable to connect to server: "+n)},ws.onerror=function(n){__debug(n),console.error(n)}}else console.error("Your browser does not support WebSocket connection")}function stripNonNumeric(n){n+="";for(var e=/^\d$/,t="",o=0;o<n.length;o++)e.test(n.charAt(o))&&("."==n.charAt(o)&&-1!=t.indexOf(".")||"-"==n.charAt(o)&&0!=t.length||(t+=n.charAt(o)));return t}function commandCenter(){function n(n,e){if(myposition==n){var t=localStorage.poplink,o=localStorage.popbody;if(void 0===t&&(t=""),void 0===o&&(o=""),""!=t){var i=/#\{[^\}]*\}/g,r=t.match(i);if(null!==r)for(var c=0;c<r.length;c++){var s=r[c].substr(2,r[c].length-3);i="",i="CLIDNUM"==s||"CLIDNAME"==s?Base64.decode(chanvars[n][s]):chanvars[n][s],t=replace(t,r[c],i)}}if("undefined"!=typeof popup&&1==popup&&(translate("&"+e),void 0!==chanvars[n]))for(s in chanvars[n]){if("CLIDNUM"==s||"CLIDNAME"==s)value=Base64.decode(chanvars[n][s]);else if(/^[0-9]*$/.test(chanvars[n][s]))value=chanvars[n][s];else try{value=windows.atob(chanvars[n][s])}catch(e){value=chanvars[n][s]}value}}}this.zbuttons=function(n,e,t){for(botonitos=[],chanvars=[],__debug(e),29<=subversion?e=Base64.decode(e).split("\n"):(n=new Inflator(new Base64Reader(e)),e=new TextReader(new Utf8Translator(n)).readToEnd().split("\n")),t=0;t<e.length;t++){var o=e[t].split("!"),i=o[0].split("@")[0];for(n=0;n<o.length;n++){var r=o[n].split("=",2);null==botonitos[i]&&(botonitos[i]={}),botonitos[i][r[0]]=r[1],""!==r[0]&&"EXTENSION"==r[0]&&r[1]==exten&&(myposition=i,__debug("My position is "+myposition))}}},this.voicemail=function(n,e,t){return!1},this.pong=function(n,e,t){setTimeout((function(){sendsPing()}),2e4),pingcount--},this.state=function(n,e,t){if(0<=inArray("RINGING",e=e.split("+"))||0<=inArray("UP",e))e="busy";else if(e="free",myposition==n&&(alreadynotified=0,void 0!==chanvars[n]))for(var o in chanvars[n])delete chanvars[n][o]},this.presence=function(n,e,t){},this.key=function(n,e,t){lastkey=e,__debug("lastkey: "+lastkey)},this.setvar=function(n,e,t){myposition==n&&1<=(e=Base64.decode(e)).indexOf("=")&&(void 0===chanvars[n]&&(chanvars[n]={}),partes=e.split("="),chanvars[n][partes[0]]=partes[1])},this.incorrect=function(n,e,t){__debug("Auth incorrect")},this.version=function(n,e,t){n=hex_md5(secret+lastkey),subversion=e.split("!")[0].split(".")[1],subversion=subversion.replace(/\D/g,""),send('<msg data="1|auth|'+exten+"|"+n+'" />')},this.qualify=function(n,e,t){return!1},this.clidnum=function(n,e,t){myposition==n&&(void 0===chanvars[n]&&(chanvars[n]={}),chanvars[n].CLIDNUM=e)},this.clidname=function(n,e,t){myposition==n&&(void 0===chanvars[n]&&(chanvars[n]={}),chanvars[n].CLIDNAME=e)},this.fromqueue=function(n,e,t){myposition==n&&(void 0===chanvars[n]&&(chanvars[n]={}),chanvars[n].FROMQUEUE=e)},this.notifyringing=function(e,t,o){n(e,"incoming_call")},this.notifyconnect=function(e,t,o){0==alreadynotified&&(n(e,"connected_call"),myposition==e&&(alreadynotified=1))}}var execute=new commandCenter;function phoneClickEventListener(n){n.preventDefault(),runBackgroundCommand("dialPhone",n.currentTarget.href.replace("callto:","").replace("tel:",""))}function addPhoneLinks(n){n.forEach(n=>{n.removeEventListener("click",phoneClickEventListener),n.addEventListener("click",phoneClickEventListener)})}function runBackgroundCommand(n,e){let t="__rw_chrome_ext_reply_"+(new Date).getTime();chrome.runtime.sendMessage({type:n,data:e},(function(e){document.createEvent("Events").initEvent(t,!1,!1),CTC.log("runBackgroundCommand."+n,e)}))}function getSettings(){return new Promise((n,e)=>{chrome.storage.local.get("settings",(function(t){t=t.settings;let o=[];CTC.requiredSettings.forEach((function(n){void 0===t[n]&&o.push(n)})),0==o.length?n(t):e({type:"error",content:"Settings is undefined",data:o})}))})}function setUpWebSockedSettings(){ssl=CTC.settings.ssl,wshost=CTC.settings.server,wsport=CTC.settings.port,exten=CTC.settings.extension,secret=CTC.settings.password}function ifFop2Page(){return!(!CTC.settings.server||!window.location.href.includes(CTC.settings.server))}function proceedPhoneLinks(){let n=!1;ifFop2Page()&&connectWebsocket(),setInterval(()=>{let e=document.querySelectorAll('a.click-to-call[href*="callto"], a.click-to-call[href*="tel"]');e.length>0?(CTC.phoneLinksInfo&&CTC.log("Phone links founded: "+e.length),!1!==n||ifFop2Page()||connectWebsocket(),addPhoneLinks(e),n=!0):!1===n&&CTC.phoneLinksInfo&&CTC.log("Phone links not found...")},2e3)}async function init(){CTC.settings=await getSettings(),CTC.log("CTC.settings",CTC.settings),setUpWebSockedSettings(),proceedPhoneLinks()}window.addEventListener("load",()=>{init()},!1);